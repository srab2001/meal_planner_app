// This file is part of the meal_planner monorepo
// Fitness module - Prisma schema
// Database: Render PostgreSQL (shared with main app)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// User fitness profiles - one per user
model fitness_profiles {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String   @unique @db.Uuid
  height_cm       Int?
  weight_kg       Decimal? @db.Decimal(6, 2)
  age             Int?
  gender          String?
  activity_level  String?
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)

  @@index([user_id], map: "idx_fitness_profiles_user_id")
}

/// Fitness goals - weight loss, muscle gain, endurance
model fitness_goals {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String    @db.Uuid
  goal_type    String    // "weight_loss", "muscle_gain", "endurance"
  target_value Decimal?  @db.Decimal(8, 2)
  unit         String?   // "lbs", "kg", "minutes", "reps"
  start_date   DateTime? @db.Date
  target_date  DateTime? @db.Date
  status       String    @default("active") // "active", "completed", "abandoned"
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  updated_at   DateTime  @default(now()) @db.Timestamptz(6)

  @@index([user_id], map: "idx_fitness_goals_user_id")
  @@index([status], map: "idx_fitness_goals_status")
}

/// Fitness workouts - individual workout sessions
model fitness_workouts {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id               String   @db.Uuid
  workout_date          DateTime @db.Date
  workout_type          String?  // "strength", "cardio", "hiit", "ai-generated"
  duration_minutes      Int?
  notes                 String?
  
  // AI-Generated Workout Fields
  workout_data          Json?    // Full 6-section workout structure from ChatGPT
  intensity             String?  // "low" | "medium" | "high"
  calories_burned       Int?     // Estimated calories burned
  difficulty_rating     Int?     // 1-10 scale
  
  // Interview Tracking
  interview_responses   Json?    // Store user's answers to interview questions
  
  created_at            DateTime @default(now()) @db.Timestamptz(6)
  workout_exercises     fitness_workout_exercises[]
  workout_items         workout_items[]

  @@index([user_id], map: "idx_fitness_workouts_user_id")
  @@index([workout_date], map: "idx_fitness_workouts_date")
  @@index([intensity], map: "idx_fitness_workouts_intensity")
}

/// Exercises within a workout
model fitness_workout_exercises {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workout_id      String   @db.Uuid
  exercise_name   String
  exercise_order  Int?
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  workout         fitness_workouts @relation(fields: [workout_id], references: [id], onDelete: Cascade)
  sets            fitness_workout_sets[]

  @@index([workout_id], map: "idx_fitness_workout_exercises_workout_id")
}

/// Sets for each exercise
model fitness_workout_sets {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  exercise_id     String   @db.Uuid
  set_number      Int
  reps            Int?
  weight          Decimal? @db.Decimal(8, 2)
  duration_seconds Int?
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  exercise        fitness_workout_exercises @relation(fields: [exercise_id], references: [id], onDelete: Cascade)

  @@index([exercise_id], map: "idx_fitness_workout_sets_exercise_id")
}

/// Exercise library - predefined exercises with metadata
/// This is the master exercise database used for workout creation
model exercise_definitions {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String   @db.VarChar(255)
  description       String?  @db.Text
  category          String   @db.VarChar(50) // "chest", "back", "legs", "shoulders", "arms", "core", "cardio"
  muscle_group      String?  @db.VarChar(100) // Primary muscle targeted
  secondary_muscles String[] // Array of secondary muscles
  equipment         String?  @db.VarChar(50) // "barbell", "dumbbell", "machine", "bodyweight", "cable", "kettlebell"
  difficulty_level  String   @default("beginner") @db.VarChar(20) // "beginner", "intermediate", "advanced"
  form_tips         String[] // Array of form cues and safety tips
  video_url         String?  @db.Text // Optional instructional video link
  is_compound       Boolean  @default(false) // Multi-joint movement
  is_active         Boolean  @default(true) // Available for selection
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @default(now()) @db.Timestamptz(6)

  @@index([category], map: "idx_exercise_definitions_category")
  @@index([difficulty_level], map: "idx_exercise_definitions_difficulty")
  @@index([is_active], map: "idx_exercise_definitions_active")
  @@index([equipment], map: "idx_exercise_definitions_equipment")
}

/// Admin-managed interview questions for AI Coach
/// NOTE: This table exists in the main meal_planner database (migration 006)
/// Column names match migration 006: question_text, question_type, order_position, is_active
model admin_interview_questions {
  id               Int      @id @default(autoincrement())
  question_text    String   @db.Text // The actual question text
  question_type    String   @db.VarChar(50) // "text", "multiple_choice", "yes_no", "range"
  options          Json? // Array for multiple_choice type
  option_range     Int? // For range type: max value
  order_position   Int      @default(0) // Display order
  is_active        Boolean  @default(true) // Whether to show this question
  created_at       DateTime @default(now()) @db.Timestamp(0)
  updated_at       DateTime @default(now()) @db.Timestamp(0)

  @@map("admin_interview_questions")
  @@index([is_active], map: "idx_admin_questions_active")
  @@index([order_position], map: "idx_admin_questions_position")
}

// ============================================
// WORKOUT SMS FEATURE
// ============================================

/// User phone numbers for SMS notifications
model user_phones {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String   @unique @db.Uuid
  phone_number String   @db.VarChar(20) // E.164 format: +1234567890
  is_verified  Boolean  @default(false)
  verified_at  DateTime? @db.Timestamptz(6)
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @default(now()) @db.Timestamptz(6)

  @@index([user_id], map: "idx_user_phones_user_id")
  @@index([phone_number], map: "idx_user_phones_number")
}

/// Workout items - individual exercises with completion tracking for SMS check-off
model workout_items {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workout_id      String    @db.Uuid
  exercise_name   String    @db.VarChar(255)
  section         String?   @db.VarChar(50) // "warm_up", "main", "cool_down", etc.
  item_order      Int       @default(0)
  sets            Int?
  reps            String?   @db.VarChar(50) // "10-12" or "30 seconds"
  weight          String?   @db.VarChar(50) // "bodyweight" or "20 lbs"
  notes           String?
  is_completed    Boolean   @default(false)
  completed_at    DateTime? @db.Timestamptz(6)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  workout         fitness_workouts @relation(fields: [workout_id], references: [id], onDelete: Cascade)

  @@index([workout_id], map: "idx_workout_items_workout_id")
  @@index([is_completed], map: "idx_workout_items_completed")
}

/// Share tokens for SMS workout links
/// Allows unauthenticated access to check-off workout items
model workout_share_tokens {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workout_id      String    @db.Uuid
  user_id         String    @db.Uuid
  token           String    @unique @db.VarChar(64) // Secure random token
  expires_at      DateTime  @db.Timestamptz(6)
  is_used         Boolean   @default(false)
  used_at         DateTime? @db.Timestamptz(6)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)

  @@index([token], map: "idx_workout_share_tokens_token")
  @@index([workout_id], map: "idx_workout_share_tokens_workout_id")
  @@index([user_id], map: "idx_workout_share_tokens_user_id")
  @@index([expires_at], map: "idx_workout_share_tokens_expires")
}

/// SMS delivery log for debugging and rate limiting
model sms_log {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String   @db.Uuid
  phone_number String   @db.VarChar(20)
  message_type String   @db.VarChar(50) // "workout_link", "verification", etc.
  status       String   @db.VarChar(20) // "sent", "delivered", "failed"
  twilio_sid   String?  @db.VarChar(50) // Twilio message SID
  error        String?
  created_at   DateTime @default(now()) @db.Timestamptz(6)

  @@index([user_id], map: "idx_sms_log_user_id")
  @@index([created_at], map: "idx_sms_log_created")
  @@index([status], map: "idx_sms_log_status")
}
