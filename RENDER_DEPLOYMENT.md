# Deploying Meal Planner to Render

This guide will help you deploy your meal planner application to Render.

## Prerequisites

1. A Render account (sign up at https://render.com)
2. Your GitHub repository connected to Render
3. Google OAuth credentials configured for production URLs
4. OpenAI API key

## Deployment Steps

### 1. Push Your Code to GitHub

Make sure all your changes are committed and pushed to your repository:

```bash
git add .
git commit -m "Add Render deployment configuration"
git push origin main
```

### 2. Create a New Web Service on Render

1. Go to https://dashboard.render.com
2. Click "New +" and select "Web Service"
3. Connect your GitHub repository
4. Render will detect the `render.yaml` file and use it for configuration

### 3. Configure Environment Variables

In the Render dashboard for your service, add the following environment variables:

#### Required Variables:

- **GOOGLE_CLIENT_ID**: Your Google OAuth Client ID
- **GOOGLE_CLIENT_SECRET**: Your Google OAuth Client Secret
- **GOOGLE_CALLBACK_URL**: `https://your-service-name.onrender.com/auth/google/callback`
  - Replace `your-service-name` with your actual Render service name
- **FRONTEND_BASE**: Your frontend URL (if deployed separately)
  - Example: `https://your-frontend.onrender.com`
  - Or leave empty if frontend is served from the same domain
- **OPENAI_API_KEY**: Your OpenAI API key
- **SESSION_SECRET**: Will be auto-generated by Render (or set your own)
- **NODE_ENV**: `production`
- **PORT**: `5000`

### 4. Update Google OAuth Credentials

**IMPORTANT**: You must update your Google Cloud Console settings:

1. Go to https://console.cloud.google.com/apis/credentials
2. Select your OAuth 2.0 Client ID
3. Under "Authorized redirect URIs", add:
   ```
   https://your-service-name.onrender.com/auth/google/callback
   ```
4. Click "Save"

### 5. Deploy

Once you've configured all environment variables:

1. Click "Create Web Service" (or "Manual Deploy" if already created)
2. Render will build and deploy your application
3. Monitor the logs for any errors
4. Once deployed, your service will be available at `https://your-service-name.onrender.com`

### 6. Test Your Deployment

1. Visit `https://your-service-name.onrender.com/health`
   - Should return: `{"status":"ok"}`
2. Test Google OAuth login:
   - Visit `https://your-service-name.onrender.com/auth/google`
   - You should be redirected to Google login

## Troubleshooting

### Common Issues:

1. **OAuth Error: redirect_uri_mismatch**
   - Make sure the GOOGLE_CALLBACK_URL in Render matches exactly what's in Google Cloud Console
   - Check for trailing slashes, http vs https, etc.

2. **Session/Cookie Issues**
   - The server is configured with `trust proxy` for Render
   - Cookies use `secure: true` and `sameSite: 'none'` in production
   - Make sure your frontend properly includes credentials in requests

3. **CORS Errors**
   - Update FRONTEND_BASE to match your actual frontend URL
   - The server currently allows all origins with `origin: true` - consider restricting this in production

4. **Build Failures**
   - Check Render logs for specific error messages
   - Ensure all dependencies are listed in `package.json`
   - Verify Node.js version compatibility

## Frontend Deployment

If deploying your React frontend separately:

1. Update the API base URL in your frontend code
2. Deploy to Render, Vercel, or Netlify
3. Set FRONTEND_BASE environment variable to your frontend URL
4. Update Google OAuth redirect to point to your frontend

## Auto-Deploy from GitHub

Render automatically deploys when you push to your main branch. To disable:

1. Go to your service settings
2. Find "Auto-Deploy"
3. Toggle off if you want manual control

## Monitoring

- **Logs**: View real-time logs in Render dashboard
- **Health Check**: Render pings `/health` endpoint automatically
- **Metrics**: View CPU, memory usage in dashboard

## Environment Variables Reference

| Variable | Required | Description |
|----------|----------|-------------|
| GOOGLE_CLIENT_ID | Yes | Google OAuth Client ID |
| GOOGLE_CLIENT_SECRET | Yes | Google OAuth Client Secret |
| GOOGLE_CALLBACK_URL | Yes | Full callback URL for OAuth |
| FRONTEND_BASE | Yes | Frontend URL for redirects |
| OPENAI_API_KEY | Yes | OpenAI API key |
| SESSION_SECRET | Yes | Secret for session encryption |
| NODE_ENV | Yes | Set to 'production' |
| PORT | Yes | Server port (5000) |

## Next Steps

After successful deployment:

1. Test all authentication flows
2. Verify meal generation functionality (once implemented)
3. Set up custom domain (optional)
4. Configure monitoring and alerts
5. Set up database (if needed for user data persistence)

## Support

For issues with:
- Render platform: https://render.com/docs
- Google OAuth: https://console.cloud.google.com/apis/credentials
- This application: Check application logs in Render dashboard
